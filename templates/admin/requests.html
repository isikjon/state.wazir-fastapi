{% extends "admin/base.html" %}

{% block title %}Wazir Недвижимость - Заявки{% endblock %}

{% block page_title %}Заявки{% endblock %}

{% block content %}
<div class="p-5"> 
    <!-- Табы для переключения между типами заявок -->
    <div class="bg-white rounded-lg shadow-sm mb-6">
        <div class="flex border-b">
            <a href="{{ url_for('admin_requests') }}?tab=listings"
                class="tab-link active">
                <!-- <a href="{{ url_for('admin_requests') }}?tab=listings"
                class="tab-link {{ 'active' if tab == 'listings' else '' }} active"> -->
                <div class="flex items-center gap-2">
                    <i class="fas fa-building"></i>
                    <span>Новые объявления</span>
                    <span class="tab-count">{{ listing_requests_count }}</span>
                </div>
            </a>
        </div>
    </div>

    <!-- Содержимое вкладки -->
    <div class="bg-white rounded-lg shadow-sm p-0">
        <!-- Фильтры и поиск -->
        <div class="flex flex-wrap gap-4 p-5 border-b">
            <div class="filter-select">
                <select id="statusFilter" class="filter-select-input">
                    <option value>Все статусы</option>
                    <option value="new" {{ 'selected' if status == 'new' else '' }}>Ожидающие</option>
                </select>
            </div>

            <div class="filter-select">
                <select id="typeFilter" class="filter-select-input">
                    <option value>Все типы</option>
                    {% for cat in categories %}
                    <option value="{{ cat.id }}" {{ 'selected' if property_type == cat.id|string else '' }}>{{ cat.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        {% if requests %}
        <!-- Список заявок -->
        <div class="requests-list">
            {% for request in requests %}
            <div class="request-item">
                <div class="request-item-image">
                    <img src="{{ request.property.image_url }}"
                        alt="{{ request.property.title }}">
                    {% if request.status == 'new' %}
                    <div class="status-badge new">Новая</div>
                    {% elif request.status == 'in_progress' %}
                    <div class="status-badge in-progress">В работе</div>
                    {% elif request.status == 'completed' %}
                    <div class="status-badge completed">Завершена</div>
                    {% elif request.status == 'rejected' %}
                    <div class="status-badge rejected">Отклонена</div>
                    {% endif %}
                </div>

                <div class="request-item-content">
                    <div class="request-title">{{ request.property.title
                        }}</div>
                    <div class="request-address">{{ request.property.address
                        }}</div>
                    {% if request.scheduled_date %}
                    <div style="margin-top: 8px; font-weight: bold; color: #0066cc; background-color: #e6f7ff; padding: 5px 10px; border-radius: 4px; display: inline-block;">
                        <i class="fas fa-calendar-check"></i>
                        <span> Дата съемки 360: {{ request.scheduled_date }}</span>
                    </div>
                    {% endif %}
                    <div class="request-price">{{
                        request.property.price_formatted }}</div>

                    <div class="request-meta">
                        <div class="request-created">
                            <i class="far fa-clock"></i>
                            <span>{{ request.created_at }}</span>
                        </div>
                        <div class="request-user">
                            <i class="far fa-user"></i>
                            <span>{{ request.user.name }}</span>
                        </div>
                        <div class="request-id">
                            <i class="far fa-hashtag"></i>
                            <span>ID: {{ request.id }}</span>
                        </div>
                    </div>
                </div>

                <div class="request-item-actions">
                    {% if tab == 'tours' %}
                    {% if request.status == 'new' %}
                    <button class="action-btn schedule"
                        data-request-id="{{ request.id }}">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Назначить</span>
                    </button>
                    <button class="action-btn reject"
                        data-request-id="{{ request.id }}">
                        <i class="fas fa-times"></i>
                        <span>Отклонить</span>
                    </button>
                    {% elif request.scheduled_date %}
                    <div class="scheduled-date">
                        <i class="fas fa-calendar-check"></i>
                        <span>Дата съемки: {{ request.scheduled_date }}</span>
                    </div>
                    <button class="action-btn complete"
                        data-request-id="{{ request.id }}">
                        <i class="fas fa-check-double"></i>
                        <span>Завершить</span>
                    </button>
                    <button class="action-btn reschedule"
                        data-request-id="{{ request.id }}">
                        <i class="fas fa-sync-alt"></i>
                        <span>Перенести</span>
                    </button>
                    {% else %}
                    <button class="action-btn view"
                        data-request-id="{{ request.id }}">
                        <i class="fas fa-eye"></i>
                        <span>Просмотр</span>
                    </button>
                    <button class="action-btn archive"
                        data-request-id="{{ request.id }}">
                        <i class="fas fa-archive"></i>
                        <span>В архив</span>
                    </button>
                    {% endif %}
                    {% else %}
                    {% if request.status == 'new' %}
                    <button class="action-btn accept"
                        data-request-id="{{ request.id }}">
                        <i class="fas fa-check"></i>
                        <span>Одобрить</span>
                    </button>
                    <button class="action-btn reject"
                        data-request-id="{{ request.id }}">
                        <i class="fas fa-times"></i>
                        <span>Отклонить</span>
                    </button>
                    {% elif request.status == 'in_progress' %}
                    <button class="action-btn complete"
                        data-request-id="{{ request.id }}">
                        <i class="fas fa-check-double"></i>
                        <span>Опубликовать</span>
                    </button>
                    <button class="action-btn edit"
                        data-request-id="{{ request.id }}">
                        <i class="fas fa-edit"></i>
                        <span>Изменить</span>
                    </button>
                    <button class="action-btn reject"
                        data-request-id="{{ request.id }}">
                        <i class="fas fa-times"></i>
                        <span>Отклонить</span>
                    </button>
                    {% else %}
                    <button class="action-btn view"
                        data-request-id="{{ request.id }}">
                        <i class="fas fa-eye"></i>
                        <span>Просмотр</span>
                    </button>
                    <button class="action-btn archive"
                        data-request-id="{{ request.id }}">
                        <i class="fas fa-archive"></i>
                        <span>В архив</span>
                    </button>
                    {% endif %}
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Пагинация -->
        <div class="pagination-container">
            <div class="pagination-info">
                Показано {{ start_item }} - {{ end_item }} из {{ total_requests
                }} заявок
            </div>

            <div class="pagination">
                {% if page > 1 %}
                <a
                    href="{{ url_for('admin_requests') }}?tab={{ tab }}&page={{ page - 1 }}{{ query_params }}"
                    class="pagination-btn">
                    <i class="fas fa-chevron-left"></i>
                </a>
                {% else %}
                <span class="pagination-btn disabled">
                    <i class="fas fa-chevron-left"></i>
                </span>
                {% endif %}

                {% for p in pages %}
                {% if p == page %}
                <span class="pagination-btn active">{{ p }}</span>
                {% else %}
                <a
                    href="{{ url_for('admin_requests') }}?tab={{ tab }}&page={{ p }}{{ query_params }}"
                    class="pagination-btn">{{ p }}</a>
                {% endif %}
                {% endfor %}

                {% if page < total_pages %}
                <a
                    href="{{ url_for('admin_requests') }}?tab={{ tab }}&page={{ page + 1 }}{{ query_params }}"
                    class="pagination-btn">
                    <i class="fas fa-chevron-right"></i>
                </a>
                {% else %}
                <span class="pagination-btn disabled">
                    <i class="fas fa-chevron-right"></i>
                </span>
                {% endif %}
            </div>
        </div>
        {% else %}
        <!-- Нет заявок -->
        <div class="no-requests">
            <div class="no-requests-icon">
                <i class="far fa-clipboard"></i>
            </div>
            <div class="no-requests-text">Нет активных заявок</div>
            <div class="no-requests-subtext">По выбранным фильтрам ничего не
                найдено</div>
        </div>
        {% endif %}
    </div>

    <!-- График активности модерации -->
    <div class="bg-white rounded-lg shadow-sm p-5 mt-6">
        <div class="text-lg font-semibold mb-4">Активность модерации</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="moderation-stats">
                <div class="text-sm text-gray-500 mb-2">Последние 7 дней</div>
                <div class="stats-grid">
                    {% if activity_stats is mapping %}
                    {% for day, stats in activity_stats.items() %}
                    <div class="stat-card">
                        <div class="stat-value">{{ stats.count }}</div>
                        <div class="stat-day">{{ day }}</div>
                        <div class="stat-bar">
                            <div class="stat-bar-fill" style="height: {{ stats.percentage }}%;"></div>
                        </div>
                    </div>
                    {% endfor %}
                    {% elif activity_stats is iterable and not activity_stats is
                    string %}
                    {% for stat in activity_stats %}
                    <div class="stat-card">
                        <div class="stat-value">{{ stat.count }}</div>
                        <div class="stat-day">{{ stat.day }}</div>
                        <div class="stat-bar">
                            <div class="stat-bar-fill" style="height: {{ stat.percentage }}%;"></div>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="text-gray-500">Нет данных по активности</div>
                    {% endif %}
                </div>
            </div>

            <div class="moderation-metrics">
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-icon accepted">
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="metric-content">
                            <div class="metric-value">{{ metrics.accepted
                                }}</div>
                            <div class="metric-label">Принято</div>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-icon rejected">
                            <i class="fas fa-times"></i>
                        </div>
                        <div class="metric-content">
                            <div class="metric-value">{{ metrics.rejected
                                }}</div>
                            <div class="metric-label">Отклонено</div>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-icon pending">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="metric-content">
                            <div class="metric-value">{{ metrics.pending
                                }}</div>
                            <div class="metric-label">В ожидании</div>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-icon avg-time">
                            <i class="fas fa-hourglass-half"></i>
                        </div>
                        <div class="metric-content">
                            <div class="metric-value">{{ metrics.avg_time
                                }}</div>
                            <div class="metric-label">Ср. время</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Табы заявок */
.tab-link {
    padding: 1rem 1.5rem;
    font-weight: 500;
    color: #6b7280;
    transition: all 0.2s ease;
}

.tab-link:hover {
    color: #4b5563;
    background-color: #f9fafb;
}

.tab-link.active {
    color: var(--color-primary);
    border-bottom: 2px solid var(--color-primary);
    background-color: #fff;
}

.tab-count {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    background-color: #f3f4f6;
    color: #6b7280;
    border-radius: 9999px;
    font-size: 0.75rem;
    margin-left: 0.5rem;
}

.tab-link.active .tab-count {
    background-color: #fef3c7;
    color: var(--color-primary);
}

/* Фильтры */
.filter-select {
    position: relative;
}

.filter-select-input {
    min-width: 160px;
    padding: 0.5rem 2.5rem 0.5rem 0.75rem;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    font-size: 0.875rem;
    color: #4b5563;
    background-color: white;
    appearance: none;
    cursor: pointer;
}

.filter-select::after {
    content: '\f078';
    font-family: 'Font Awesome 5 Free';
    font-weight: 900;
    position: absolute;
    right: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: #9ca3af;
    pointer-events: none;
    font-size: 0.75rem;
}

.more-filters-btn {
    display: flex;
    align-items: center;
    padding: 0.5rem 0.75rem;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    font-size: 0.875rem;
    color: #4b5563;
    background-color: white;
    cursor: pointer;
    transition: all 0.2s ease;
}

.more-filters-btn:hover {
    background-color: #f9fafb;
}

.more-filters-btn i {
    margin-right: 0.5rem;
    font-size: 0.75rem;
}

.search-box {
    position: relative;
    min-width: 260px;
}

.search-icon {
    position: absolute;
    left: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: #9ca3af;
}

#searchInput {
    width: 100%;
    padding: 0.5rem 0.75rem 0.5rem 2.5rem;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    font-size: 0.875rem;
    color: #4b5563;
}

#searchInput:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.12);
}

/* Заявки */
.requests-list {
    overflow-x: hidden;
}

.request-item {
    padding: 1.25rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    transition: background-color 0.2s ease;
}

.request-item:hover {
    background-color: #f9fafb;
}

.request-item-image {
    width: 120px;
    height: 90px;
    border-radius: 6px;
    overflow: hidden;
    position: relative;
    margin-right: 1.25rem;
    flex-shrink: 0;
}

.request-item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.status-badge {
    position: absolute;
    top: 8px;
    left: 8px;
    font-size: 0.75rem;
    font-weight: 500;
    padding: 0.15rem 0.5rem;
    border-radius: 9999px;
}

.status-badge.new {
    background-color: #fef2f2;
    color: #ef4444;
}

.status-badge.in-progress {
    background-color: #fef3c7;
    color: #b45309;
}

.status-badge.completed {
    background-color: #ecfdf5;
    color: #047857;
}

.status-badge.rejected {
    background-color: #f3f4f6;
    color: #6b7280;
}

.request-item-content {
    flex-grow: 1;
    min-width: 0;
}

.request-title {
    font-weight: 500;
    color: #1f2937;
    font-size: 1rem;
    margin-bottom: 0.25rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.request-address {
    color: #6b7280;
    font-size: 0.875rem;
    margin-bottom: 0.25rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.request-price {
    color: var(--color-primary);
    font-weight: 600;
    font-size: 1rem;
    margin-bottom: 0.5rem;
}

.request-meta {
    display: flex;
    gap: 1rem;
    color: #6b7280;
    font-size: 0.75rem;
}

.request-created,
.request-user,
.request-id {
    display: flex;
    align-items: center;
}

.request-meta i {
    margin-right: 0.35rem;
    font-size: 0.75rem;
    opacity: 0.7;
}

.request-item-actions {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    min-width: 120px;
    margin-left: 1.25rem;
}

.action-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    width: 100%;
}

.action-btn i {
    margin-right: 0.35rem;
    font-size: 0.75rem;
}

.action-btn.accept {
    background-color: #ecfdf5;
    color: #047857;
}

.action-btn.accept:hover {
    background-color: #d1fae5;
}

.action-btn.reject {
    background-color: #fef2f2;
    color: #ef4444;
}

.action-btn.reject:hover {
    background-color: #fee2e2;
}

.action-btn.schedule,
.action-btn.edit {
    background-color: #eff6ff;
    color: #2563eb;
}

.action-btn.schedule:hover,
.action-btn.edit:hover {
    background-color: #dbeafe;
}

.action-btn.complete {
    background-color: #ecfdf5;
    color: #047857;
}

.action-btn.complete:hover {
    background-color: #d1fae5;
}

.action-btn.reschedule {
    background-color: #fff7ed;
    color: #c2410c;
}

.action-btn.reschedule:hover {
    background-color: #ffedd5;
}

.action-btn.view {
    background-color: #f3f4f6;
    color: #4b5563;
}

.action-btn.view:hover {
    background-color: #e5e7eb;
}

.action-btn.archive {
    background-color: #f3f4f6;
    color: #4b5563;
}

.action-btn.archive:hover {
    background-color: #e5e7eb;
}

.scheduled-date {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem;
    border-radius: 6px;
    font-size: 0.75rem;
    background-color: #fef3c7;
    color: #b45309;
    width: 100%;
}

.scheduled-date i {
    margin-right: 0.35rem;
    font-size: 0.75rem;
}

/* Пагинация */
.pagination-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.25rem;
    border-top: 1px solid #e5e7eb;
    background-color: #f9fafb;
}

.pagination-info {
    font-size: 0.875rem;
    color: #6b7280;
}

.pagination {
    display: flex;
    gap: 0.25rem;
}

.pagination-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background-color: white;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    font-size: 0.875rem;
    color: #4b5563;
    cursor: pointer;
    transition: all 0.2s ease;
}

.pagination-btn:hover {
    background-color: #f9fafb;
}

.pagination-btn.active {
    background-color: var(--color-primary);
    color: white;
    border-color: var(--color-primary);
}

.pagination-btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Нет заявок */
.no-requests {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem 1rem;
    text-align: center;
}

.no-requests-icon {
    font-size: 3rem;
    color: #d1d5db;
    margin-bottom: 1rem;
}

.no-requests-text {
    font-size: 1.25rem;
    font-weight: 500;
    color: #4b5563;
    margin-bottom: 0.5rem;
}

.no-requests-subtext {
    font-size: 0.875rem;
    color: #6b7280;
    max-width: 400px;
}

/* Статистика активности */
.moderation-stats {
    width: 100%;
}

.stats-grid {
    display: flex;
    justify-content: space-between;
    width: 100%;
    height: 180px;
}

.stat-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    max-width: 60px;
}

.stat-value {
    font-size: 1rem;
    font-weight: 600;
    color: #4b5563;
    margin-bottom: 0.25rem;
}

.stat-day {
    font-size: 0.75rem;
    color: #6b7280;
    margin-bottom: 0.5rem;
}

.stat-bar {
    width: 30px;
    height: 120px;
    background-color: #f3f4f6;
    border-radius: 4px;
    position: relative;
}

.stat-bar-fill {
    position: absolute;
    bottom: 0;
    width: 100%;
    background-color: var(--color-primary);
    border-radius: 4px;
}

/* Метрики модерации */
.moderation-metrics {
    width: 100%;
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    height: 100%;
}

.metric-card {
    display: flex;
    align-items: center;
    padding: 1rem;
    background-color: #f9fafb;
    border-radius: 6px;
}

.metric-icon {
    width: 40px;
    height: 40px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    font-size: 1rem;
    color: white;
}

.metric-icon.accepted {
    background-color: #047857;
}

.metric-icon.rejected {
    background-color: #ef4444;
}

.metric-icon.pending {
    background-color: #b45309;
}

.metric-icon.avg-time {
    background-color: #2563eb;
}

.metric-content {
    flex-grow: 1;
}

.metric-value {
    font-size: 1.25rem;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 0.15rem;
}

.metric-label {
    font-size: 0.75rem;
    color: #6b7280;
}

/* Респонсивный дизайн */
@media (max-width: 768px) {
    .request-item {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .request-item-image {
        width: 100%;
        height: 180px;
        margin-right: 0;
        margin-bottom: 1rem;
    }
    
    .request-item-content {
        width: 100%;
        margin-bottom: 1rem;
    }
    
    .request-item-actions {
        width: 100%;
        flex-direction: row;
        margin-left: 0;
    }
    
    .action-btn {
        flex: 1;
    }
    
    .pagination-container {
        flex-direction: column;
        gap: 1rem;
    }
    
    .pagination {
        width: 100%;
        justify-content: center;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Фильтры
        $('#statusFilter, #typeFilter').on('change', function() {
            applyFilters();
        });
        
        // Поиск
        let searchTimeout;
        $('#searchInput').on('keyup', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(function() {
                applyFilters();
            }, 500);
        });
        
        // Применение фильтров
        function applyFilters() {
            const status = $('#statusFilter').val();
            const type = $('#typeFilter').val();
            let url = `{{ url_for('admin_requests') }}?tab={{ tab }}`;
            if (status) url += `&status=${status}`;
            if (type) url += `&property_type=${type}`;
            window.location.href = url;
        }
        
        // Дополнительные фильтры
        $('#moreFiltersBtn').on('click', function() {
            alert('Дополнительные фильтры - в разработке');
        });
        
        // Обработка кнопок действий
        $('.action-btn').on('click', function() {
            const requestId = $(this).data('request-id');
            // Извлекаем все классы и находим класс действия (accept, reject, schedule, etc.)
            const classes = $(this).attr('class').split(' ');
            let action = '';
            
            // Ищем класс действия среди всех классов кнопки
            for (const cls of classes) {
                if (['accept', 'reject', 'schedule', 'complete', 'reschedule', 'edit', 'view', 'archive'].includes(cls)) {
                    action = cls;
                    break;
                }
            }
            
            switch(action) {
                case 'accept':
                    acceptRequest(requestId);
                    break;
                case 'reject':
                    rejectRequest(requestId);
                    break;
                case 'schedule':
                    scheduleRequest(requestId);
                    break;
                case 'complete':
                    completeRequest(requestId);
                    break;
                case 'reschedule':
                    rescheduleRequest(requestId);
                    break;
                case 'edit':
                    editRequest(requestId);
                    break;
                case 'view':
                    viewRequest(requestId);
                    break;
                case 'archive':
                    archiveRequest(requestId);
                    break;
            }
        });
        
        // Получение токена авторизации из куки
        function getAuthHeader() {
            if (document.cookie.includes('access_token')) {
                const token = document.cookie.split('access_token=')[1].split(';')[0];
                return { 'Authorization': `Bearer ${token}` };
            }
            return {};
        }
        
        // Функции обработки действий
        function acceptRequest(id) {
            if (confirm('Одобрить объявление #' + id + '?')) {
                fetch(`/api/v1/properties/${id}/approve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeader()
                    }
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Ошибка ответа: ' + response.status);
                })
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Ошибка: ' + (data.detail || 'Неизвестная ошибка'));
                    }
                })
                .catch(error => {
                    alert('Произошла ошибка при обработке запроса: ' + error.message);
                    console.error(error);
                });
            }
        }
        
        function rejectRequest(id) {
            if (confirm('Отклонить объявление #' + id + '?')) {
                fetch(`/api/v1/properties/${id}/reject`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeader()
                    }
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Ошибка ответа: ' + response.status);
                })
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Ошибка: ' + (data.detail || 'Неизвестная ошибка'));
                    }
                })
                .catch(error => {
                    alert('Произошла ошибка при обработке запроса: ' + error.message);
                    console.error(error);
                });
            }
        }
        
        function scheduleRequest(id) {
            const scheduledDate = prompt('Укажите дату съемки 360 (ДД.ММ.ГГГГ) для объявления #' + id);
            if (scheduledDate) {
                fetch(`/api/v1/properties/${id}/schedule`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeader()
                    },
                    body: JSON.stringify({ scheduled_date: scheduledDate })
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Ошибка ответа: ' + response.status);
                })
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Ошибка: ' + (data.detail || 'Неизвестная ошибка'));
                    }
                })
                .catch(error => {
                    alert('Произошла ошибка при обработке запроса: ' + error.message);
                    console.error(error);
                });
            }
        }
        
        function completeRequest(id) {
            if (confirm('Завершить съемку 360 для объявления #' + id + '?')) {
                fetch(`/api/v1/properties/${id}/complete-tour`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeader()
                    }
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Ошибка ответа: ' + response.status);
                })
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Ошибка: ' + (data.detail || 'Неизвестная ошибка'));
                    }
                })
                .catch(error => {
                    alert('Произошла ошибка при обработке запроса: ' + error.message);
                    console.error(error);
                });
            }
        }
        
        function rescheduleRequest(id) {
            const date = prompt('Укажите новую дату съемки (ДД.ММ.ГГГГ) для объявления #' + id);
            if (date) {
                fetch(`/api/v1/properties/${id}/schedule`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeader()
                    },
                    body: JSON.stringify({ scheduled_date: date })
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Ошибка ответа: ' + response.status);
                })
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Ошибка: ' + (data.detail || 'Неизвестная ошибка'));
                    }
                })
                .catch(error => {
                    alert('Произошла ошибка при обработке запроса: ' + error.message);
                    console.error(error);
                });
            }
        }
        
        function editRequest(id) {
            window.location.href = `/admin/requests/${id}/edit`;
        }
        
        function viewRequest(id) {
            window.location.href = `/admin/requests/${id}`;
        }
        
        function archiveRequest(id) {
            if (confirm('Архивировать заявку #' + id + '?')) {
                fetch(`/api/v1/requests/${id}/archive`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Ошибка: ' + data.message);
                    }
                })
                .catch(error => {
                    alert('Произошла ошибка при обработке запроса');
                    console.error(error);
                });
            }
        }
    });
</script>
{% endblock %}