{% extends "companies/base.html" %}

{% block title %}Объявления - Wazir Business{% endblock %}
{% block page_title %}Объявления{% endblock %}
{% block page_subtitle %}Управление объявлениями недвижимости{% endblock %}

{% block header_actions %}
<a href="/companies/listings/create" class="btn-primary px-4 py-2 rounded-lg text-white text-sm font-medium flex items-center">
    <i class="fas fa-plus mr-2"></i>
    Создать объявление
</a>
{% endblock %}

{% block content %}
<!-- Фильтры -->
<div class="bg-white rounded-lg p-6 border border-gray-200 mb-6">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Поиск</label>
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-search text-gray-400"></i>
                </div>
                <input type="text" id="searchInput" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary sm:text-sm" placeholder="Название, адрес...">
            </div>
        </div>
        
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Статус</label>
            <select id="statusFilter" class="block w-full px-3 py-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary sm:text-sm">
                <option value="">Все статусы</option>
                <option value="active">Активные</option>
                <option value="pending">На модерации</option>
                <option value="draft">Черновики</option>
                <option value="rejected">Отклоненные</option>
            </select>
        </div>
        
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Тип</label>
            <select id="typeFilter" class="block w-full px-3 py-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary sm:text-sm">
                <option value="">Все типы</option>
                <option value="sale">Продажа</option>
                <option value="rent">Аренда</option>
            </select>
        </div>
        
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Сортировка</label>
            <select id="sortFilter" class="block w-full px-3 py-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary sm:text-sm">
                <option value="created_desc">По дате (новые)</option>
                <option value="created_asc">По дате (старые)</option>
                <option value="price_desc">По цене (дорогие)</option>
                <option value="price_asc">По цене (дешевые)</option>
                <option value="views_desc">По просмотрам</option>
            </select>
        </div>
    </div>
</div>

<!-- Статистика -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-white rounded-lg p-4 border border-gray-200">
        <div class="flex items-center">
            <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                <i class="fas fa-list text-blue-600"></i>
            </div>
            <div>
                <p class="text-sm text-gray-600">Всего</p>
                <p class="text-lg font-semibold text-gray-900">{{ total_count or 0 }}</p>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg p-4 border border-gray-200">
        <div class="flex items-center">
            <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                <i class="fas fa-check text-green-600"></i>
            </div>
            <div>
                <p class="text-sm text-gray-600">Активные</p>
                <p class="text-lg font-semibold text-gray-900">{{ active_count or 0 }}</p>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg p-4 border border-gray-200">
        <div class="flex items-center">
            <div class="w-8 h-8 bg-yellow-100 rounded-lg flex items-center justify-center mr-3">
                <i class="fas fa-clock text-yellow-600"></i>
            </div>
            <div>
                <p class="text-sm text-gray-600">На модерации</p>
                <p class="text-lg font-semibold text-gray-900">{{ pending_count or 0 }}</p>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg p-4 border border-gray-200">
        <div class="flex items-center">
            <div class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center mr-3">
                <i class="fas fa-file-alt text-gray-600"></i>
            </div>
            <div>
                <p class="text-sm text-gray-600">Черновики</p>
                <p class="text-lg font-semibold text-gray-900">{{ draft_count or 0 }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Список объявлений -->
<div class="bg-white rounded-lg border border-gray-200">
    <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-900">Мои объявления</h3>
            <div class="flex items-center space-x-2">
                <button id="gridView" class="p-2 text-gray-400 hover:text-gray-600">
                    <i class="fas fa-th-large"></i>
                </button>
                <button id="listView" class="p-2 text-primary">
                    <i class="fas fa-list"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Table View -->
    <div id="tableView" class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        <input type="checkbox" id="selectAll" class="rounded border-gray-300 text-primary focus:ring-primary">
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Объявление</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Цена</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Тип</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Статус</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Просмотры</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Дата</th>
                    <th class="relative px-6 py-3"><span class="sr-only">Действия</span></th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for property in properties %}
                <tr class="hover:bg-gray-50 property-row" data-status="{{ property.status }}" data-type="{{ property.property_type }}">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="checkbox" class="property-checkbox rounded border-gray-300 text-primary focus:ring-primary" value="{{ property.id }}">
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-gray-200 rounded-lg mr-4 flex-shrink-0">
                                {% if property.image_url %}
                                <img src="{{ property.image_url }}" alt="{{ property.title }}" class="w-full h-full object-cover rounded-lg">
                                {% else %}
                                <div class="w-full h-full flex items-center justify-center">
                                    <i class="fas fa-image text-gray-400"></i>
                                </div>
                                {% endif %}
                            </div>
                            <div>
                                <div class="text-sm font-medium text-gray-900">{{ property.title }}</div>
                                <div class="text-sm text-gray-500">{{ property.address }}</div>
                                {% if property.rooms %}
                                <div class="text-xs text-gray-400 mt-1">{{ property.rooms }} комн. • {{ property.area }} м²</div>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">{{ "{:,.0f}".format(property.price) }} ₽</div>
                        {% if property.property_type == 'rent' %}
                        <div class="text-xs text-gray-500">в месяц</div>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if property.property_type == 'sale' %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            Продажа
                        </span>
                        {% else %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                            Аренда
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if property.status == 'active' %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            <i class="fas fa-check mr-1"></i>Активно
                        </span>
                        {% elif property.status == 'pending' %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                            <i class="fas fa-clock mr-1"></i>На модерации
                        </span>
                        {% elif property.status == 'draft' %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                            <i class="fas fa-file-alt mr-1"></i>Черновик
                        </span>
                        {% else %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                            <i class="fas fa-times mr-1"></i>Отклонено
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <div class="flex items-center">
                            <i class="fas fa-eye text-gray-400 mr-1"></i>
                            {{ property.views or 0 }}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ property.created_at.strftime('%d.%m.%Y') if property.created_at else '-' }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <div class="flex items-center space-x-2">
                            <a href="/companies/listings/{{ property.id }}" class="text-primary hover:text-primary-dark" title="Просмотр">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a href="/companies/listings/{{ property.id }}/edit" class="text-gray-400 hover:text-gray-600" title="Редактировать">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button onclick="deleteProperty({{ property.id }})" class="text-red-400 hover:text-red-600" title="Удалить">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                
                {% if not properties %}
                <tr>
                    <td colspan="8" class="px-6 py-12 text-center">
                        <i class="fas fa-plus-circle text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 mb-4">У вас пока нет объявлений</p>
                        <a href="/companies/listings/create" class="btn-primary px-4 py-2 rounded-lg text-white text-sm font-medium">
                            Создать первое объявление
                        </a>
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
    
    <!-- Grid View (скрыт по умолчанию) -->
    <div id="gridView" class="hidden p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for property in properties %}
            <div class="card bg-white border border-gray-200 rounded-lg overflow-hidden property-card" data-status="{{ property.status }}" data-type="{{ property.property_type }}">
                <div class="aspect-w-16 aspect-h-9 bg-gray-200">
                    {% if property.image_url %}
                    <img src="{{ property.image_url }}" alt="{{ property.title }}" class="w-full h-48 object-cover">
                    {% else %}
                    <div class="w-full h-48 flex items-center justify-center bg-gray-100">
                        <i class="fas fa-image text-gray-400 text-3xl"></i>
                    </div>
                    {% endif %}
                </div>
                
                <div class="p-4">
                    <div class="flex items-start justify-between mb-2">
                        <h3 class="text-sm font-medium text-gray-900 truncate flex-1">{{ property.title }}</h3>
                        <div class="ml-2">
                            {% if property.status == 'active' %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                Активно
                            </span>
                            {% elif property.status == 'pending' %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                Модерация
                            </span>
                            {% elif property.status == 'draft' %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                Черновик
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                Отклонено
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <p class="text-xs text-gray-500 mb-2">{{ property.address }}</p>
                    <p class="text-lg font-semibold text-primary mb-2">{{ "{:,.0f}".format(property.price) }} ₽</p>
                    
                    <div class="flex items-center justify-between text-xs text-gray-500 mb-3">
                        <span><i class="fas fa-eye mr-1"></i>{{ property.views or 0 }}</span>
                        <span>{{ property.created_at.strftime('%d.%m.%Y') if property.created_at else '-' }}</span>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <a href="/companies/listings/{{ property.id }}" class="flex-1 bg-primary text-white text-xs font-medium py-2 px-3 rounded-lg text-center hover:bg-primary-dark">
                            Просмотр
                        </a>
                        <a href="/companies/listings/{{ property.id }}/edit" class="bg-gray-100 text-gray-700 text-xs font-medium py-2 px-3 rounded-lg hover:bg-gray-200">
                            Изменить
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="px-6 py-4 border-t border-gray-200">
        <div class="flex items-center justify-between">
            <div class="text-sm text-gray-700">
                Показано {{ ((current_page - 1) * per_page + 1) }} - {{ min(current_page * per_page, total_count) }} из {{ total_count }} результатов
            </div>
            <div class="flex items-center space-x-2">
                {% if current_page > 1 %}
                <a href="?page={{ current_page - 1 }}" class="px-3 py-2 text-sm text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                    Назад
                </a>
                {% endif %}
                
                {% for page in range(1, total_pages + 1) %}
                    {% if page == current_page %}
                    <span class="px-3 py-2 text-sm text-white bg-primary border border-primary rounded-lg">
                        {{ page }}
                    </span>
                    {% elif page <= 3 or page >= total_pages - 2 or (page >= current_page - 1 and page <= current_page + 1) %}
                    <a href="?page={{ page }}" class="px-3 py-2 text-sm text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                        {{ page }}
                    </a>
                    {% elif page == 4 or page == total_pages - 3 %}
                    <span class="px-3 py-2 text-sm text-gray-500">...</span>
                    {% endif %}
                {% endfor %}
                
                {% if current_page < total_pages %}
                <a href="?page={{ current_page + 1 }}" class="px-3 py-2 text-sm text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                    Далее
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // View toggle
    const gridViewBtn = document.getElementById('gridView');
    const listViewBtn = document.getElementById('listView');
    const tableView = document.getElementById('tableView');
    const gridView = document.getElementById('gridView');
    
    gridViewBtn.addEventListener('click', function() {
        tableView.classList.add('hidden');
        gridView.classList.remove('hidden');
        gridViewBtn.classList.add('text-primary');
        gridViewBtn.classList.remove('text-gray-400');
        listViewBtn.classList.add('text-gray-400');
        listViewBtn.classList.remove('text-primary');
    });
    
    listViewBtn.addEventListener('click', function() {
        gridView.classList.add('hidden');
        tableView.classList.remove('hidden');
        listViewBtn.classList.add('text-primary');
        listViewBtn.classList.remove('text-gray-400');
        gridViewBtn.classList.add('text-gray-400');
        gridViewBtn.classList.remove('text-primary');
    });
    
    // Filters
    function applyFilters() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const status = document.getElementById('statusFilter').value;
        const type = document.getElementById('typeFilter').value;
        
        const rows = document.querySelectorAll('.property-row');
        const cards = document.querySelectorAll('.property-card');
        
        [...rows, ...cards].forEach(item => {
            const title = item.querySelector('.text-sm.font-medium').textContent.toLowerCase();
            const itemStatus = item.dataset.status;
            const itemType = item.dataset.type;
            
            const matchesSearch = !search || title.includes(search);
            const matchesStatus = !status || itemStatus === status;
            const matchesType = !type || itemType === type;
            
            if (matchesSearch && matchesStatus && matchesType) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    }
    
    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('statusFilter').addEventListener('change', applyFilters);
    document.getElementById('typeFilter').addEventListener('change', applyFilters);
    
    // Select all checkbox
    document.getElementById('selectAll').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.property-checkbox');
        checkboxes.forEach(cb => cb.checked = this.checked);
    });
    
    // Delete function
    async function deleteProperty(propertyId) {
        const result = await Swal.fire({
            title: 'Удалить объявление?',
            text: 'Это действие нельзя отменить',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc2626',
            cancelButtonColor: '#6b7280',
            confirmButtonText: 'Удалить',
            cancelButtonText: 'Отмена'
        });
        
        if (result.isConfirmed) {
            try {
                const response = await fetch(`/api/v1/companies/properties/${propertyId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (response.ok) {
                    Swal.fire('Удалено!', 'Объявление было удалено', 'success');
                    location.reload();
                } else {
                    throw new Error('Ошибка при удалении');
                }
            } catch (error) {
                Swal.fire('Ошибка!', 'Не удалось удалить объявление', 'error');
            }
        }
    }
</script>
{% endblock %} 