#!/bin/bash
set -e

# Функция для ожидания готовности базы данных
wait_for_db() {
  echo "Ожидание запуска базы данных..."
  host=$(echo $DATABASE_URL | sed -E 's/.*@([^/]+)\/.*/\1/' | cut -d':' -f1)
  echo "Хост базы данных: $host"
  
  while ! nc -z $host 3306; do
    echo "MySQL пока недоступен - ожидание..."
    sleep 2
  done
  
  echo "MySQL запущен и готов!"
}

# Выполняем миграции Alembic
run_migrations() {
  echo "Применение миграций базы данных..."
  # Временно отключено из-за проблем с множественными головными ревизиями
  # alembic upgrade head
  echo "Миграции пропущены (ручная настройка)!"
}

# Ожидаем запуск базы данных перед запуском приложения
wait_for_db

# Применяем миграции
run_migrations

# Запускаем приложение
echo "Запуск приложения..."
exec "$@"
